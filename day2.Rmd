# Day 2 lectures and exercises

## Read in the Titanic mortality data set

The following is for my own benefit. You do not need to run this.

```{r clean-slate}
rm(list=ls())
```

You should find the data file on mortality among passengers
of the Titanic at

--> http://www.statsci.org/data/general/titanic.txt

A brief description of this file is available at

--> http://www.statsci.org/data/general/titanic.html

You need to read in the file using the read.table function.

```{r read}
# ti <- read.table(file="http://www.statsci.org/data/general/titanic.txt")
```

There is an issue on the 38th line of the file. You need to download the file
and fix it and then read it locally.

```{r read2}
# ti <- read.table(file="day2_titanic_v02.txt")
```

Oops! There is one more problem, fix this, save under a different name
and then read it in.

```{r read3}
ti <- read.table(file="day2_titanic_v03.txt")
head(ti)
tail(ti)
```

Darn it all, we almost have it. But the variable names are listed as
the first row of the data set. Take a look at the help file for the
read.table function to see how to fix this.

```{r read4}
ti <- read.table(file="day2_titanic_v03.txt",header=TRUE)
head(ti)
tail(ti)
```

Notice that Miss Tamini Zabour has an "NA" for age.  We'll take a 
careful look at this later.

## On your own

Who is the oldest passenger on the Titanic. Did he/she survive?

## Categorical versus continuous variables

A categorical variable is defined (loosely) as a variable that has
a small number of possible values. Each value is usually associated
with a particular category or label. In contrast, a continuous
variable is defined as a variable that has a large number of possible
values, potentially any value in a particular interval.

Yesterday, almost all of the variables that you used were continuous.
Today, almost all of the variables that you will use will be
categorical.

The distinction between continuous and categorical variables is
important in deciding what types of descriptive and inferential
statistics you should use. But, there is often gray and fuzzy line
between categorical and continuous variables. Don't worry too much
about this today. If you're not sure whether a variable is 
categorical or continuous, try some simple descriptive statistics
and graphs appropriate for categorical data and then try some
simple descriptive statistics and graphs for continuous data. You
will usually figure out quickly whehther treating your variable
as categorical or continuous makes the most sense.

There are other types of variables also, such as count variables,
that have their own special features.

## Frequency counts

For categorical variables, you should first get frequency counts.

```{r table-simple}
table(ti$PClass)
```

Unlike most other statistical packages, R tends to have a minimalist
approach to statistics. So the table function produces only counts. If
you want percentages in addition to counts, there are several approaches.

The prop.table function takes a frequency table and converts it to
a proportion.

```{r table-proportion}
tb <- table(ti$PClass)
prop.table(tb)
```

Multiply by 100 and round to get percentages.

```{r table-pct}
pct <- round(100*prop.table(tb))
pct
```

You can get even fancier. The paste function concatenates
several string variables and if something is not a string,
R will convert it to a string before concatenating.

```{r table-pct-sign}
pct.sign <- "%"
paste(pct,pct.sign,sep="")
```

Somehow, the names of the passenger class got lost. So let's add them
back in.

```{r table-names}
paste(names(pct),pct,pct.sign,sep="")
```

You can add spacing and a bit of punctuation to make the output
look more readable.

```{r table-punctuation}
colon <- ": "
paste(names(tb),colon,pct,pct.sign,sep="")
```

Finally, you can combine the counts and the total with the 
percents to make things look really nice.

```{r fractions}
n  <- sum(tb)
slash <- "/"
comma <- ", "
paste(names(tb),colon,tb,slash,n,comma,pct,pct.sign,sep="")
```

This shows how I like to program in R. First, get something simple.
Then slowly add layers to it until you get a nice polished product.

In contrast, most other statistical packages try to produce
polished results right from the start. This has some advantages,
but the approach used by R, where many of the functions do 
something simple and basic, allows you to polish the results
the way you want them.

# Tables that include counts of missing values.

The default option in the table function is to not list missing
values. During the intitial data screening, you should always
look for missing values. This is done with the useNA argument.

```{r table-usena}
table(ti$PClass,useNA="always")
```

You can add a total count to the frequency table with
the addmargins function.

```{r table-addmargins}
addmargins(table(ti$PClass,useNA="always"))
```

## On your own

Run frequency counts for Sex and Survived. Be sure to look
for missing values for these two variables.

## Use of the summary function

Last time, we learned about the summary function, which produced
the minimum, maximum, quartiles, mean, and missing value counts.
Summary will actually look at the argument being passed to it
and try to produce different summary statistics based on what
the argument looks like. This, in technical terms, is an
object-oriented feature of the R programming language (the use
of classes and methods, to be more specificd).

If the argument sent to summary is a character vector rather than
a numeric vector, it will use frequency counts. So notice the difference
between


```{r summary}
summary(ti$PClass)
```

and

```{r summary2}
summary(ti$Age)
```

Sometimes this is very nice but sometimes it is not so nice.

```{r summary3}
summary(ti$Sex)
summary(ti$Survived)
```

## Factors

When you have a categorical variable that uses number codes,
you need to either handle this as a special case, or you need
to create a factor variable.

```{r summary4}
ti$surv.factor <- factor(ti$Survived,levels=0:1,labels=c("No","Yes"))
summary(ti$surv.factor)
```

The factor function is similar to the variable label in SPSS and
the format statement in SAS. It assigns category names (No and Yes)
to numeric codes (0 and 1). It also has other features that are helpful
in linear and logistic regression models, such as the ability to specify
contrasts.

## Bar plots

I'm not a big fan of bar plots, but they sometimes have their uses. You 
can get a barplot for the frequency count

```{r barplot}
barplot(table(ti$PClass))
```

or for the percentage (note the use of the ylab argument here).

```{r barplot2}
barplot(100*prop.table(table(ti$PClass)),ylab="Percent")
```

You can make things even nicer by pasting a percent sign on the
vertical axis tick marks.

```{r barplot3}
barplot(100*prop.table(table(ti$PClass)),axes=FALSE)
axis(side=2,at=10*(0:5),labels=paste(10*(0:5),"%",sep=""))
```

## On your own

Add label "Passenger class" to the x-axis of this bar plot.

## Crosstabulations

When you are looking at the relationship between two categorical
variables, you need to start with a crosstabulation. You use the
table function in R with two arguments to create a crosstabulation.

```{r crosstabs}
table(ti$PClass,ti$surv.factor)
```

The first variable is the rows and the second variable is the columns.

As a general rule of thumb, if one variable tends to have a lot of 
categories, I tend to put that in the rows. This allows you to scan
the many categories with an up/down scroll rather than a left/right
scroll. There are other rules of thumb for which variable to choose
for your rows and which to choose for your columns in a
crosstabulation.

Again, notice that R is rather minimalist in its approach. You do not
see any row or column totals. You can get these with the addmargins
function.

```{r add.margins}
ct <- table(ti$PClass,ti$surv.factor)
addmargins(ct,1)
addmargins(ct,2)
addmargins(ct)
```

## Table percentages.

Percentages in a crosstabulation are actually quite tricky. You can
compute a percentage across the entire table (which would be called 
a cell percent in SPSS and SAS). It helps to round these results.

```{r cell}
prop.table(ct)
round(100*prop.table(ct))
```

These percentages add to 100% across all of the table. In contrast,
row percentages add up to 100% within each row.

```{r row}
round(100*prop.table(ct,margin=1))
```

This is a rather cryptic command and it shows one area for R where
getting simple statistics is a lot harder than in SAS or SPSS.

Column percentages add up to 100% within each column.

```{r column}
round(100*prop.table(ct,margin=2))
```

It is not always clear whether you should use row, column, or
cell percents. You can find some general advice at
--> http://www.pmean.com/02/percentage.html
but to be honest, the best approach is to try several approaches
and see what works best. I have found that I usually like
row percentages in a crosstabulation with your outcome
variables as the columns.

## On your own

Compute a table showing the relationship between sex and survival.
The Titanic sunk during a time when people really did believe in
the phrase "women and children first". Find a table of percentages
that shows the degree to which women were more likely to survive
than men.

## Creating new categorical variables

There are several ways to create a new categorical variable in R, 
but the easiest way is through the use of logical comparisons.

Suppose you wanted to compute a categorical variable called
"child" which is equal to 1 if a passenger is less than 18 years
old and 0 if a passenger is 18 or older. Here's one way to do it.

```{r recode-simple}
ti$child <- as.numeric(ti$Age<18)
```

Anytime you create a new categorical variable, you should run a
crosstabulation to check your results. Pay special attention
to how missing values are handled. I'm only printing out the head
and the tail to save space, but you should look at the entire
table.

```{r recode-check}
chk <- table(ti$Age,ti$child,useNA="always")
head(chk)
tail(chk)
```

Note that since age has lots of values, we prefer to use that as
the rows in the crosstabulation.

## On your own

Redfine a child as anyone under 21 years of age. Use the factor
function to create labels of "adult" for 0 and "child" for 1.
Are children more likely to survive than adults?

## More on recoding

Sometimes you want to combine two or more of hte categories together.
Here is how you might create a new passenger class variable with
values of 1 for second and third class and 0 for first class.

The vertical bar (|) is the R symobl for logical OR.

As before, it's a good a idea to run a crosstabulation to verify
that the new coding was done properly.

```{r recode-combine}
ti$lower.class <- as.numeric(ti$PClass=="2nd" | ti$PClass=="3rd")
table(ti$PClass,ti$lower.class)
```

## Creating multi-level categories

You can create multi-level categories using a complex logic
system, but you can do it simpler and faster with the cut
function.

```{r recode-cut}
ti$age.groups <- cut(ti$Age,breaks=c(0,2,6,9,12,19,99))
table(ti$age.groups,useNA="always")
```

The notation used by cut may be familiar to mathematicians
who know the difference between open and closed sets, but
you can choose different labels.

```{r recode-cut-label}
lb <- c("Infant","Toddler","Child","Tween","Teenager","Adult")
ti$age.groups <- cut(ti$Age,breaks=c(0,2,6,9,12,19,99),labels=lb)
table(ti$age.groups,useNA="always")
```

## Odds ratios and relative risks

The odds ratio and the relative risk are two measures that summarize
the relationship between two categorical variables. They are most
easily computed for binary variables, but there are extensions for
variables with more than two categories.

The computation of odds ratios or relative risks and their associated
confidence intervals requires the use of a special library. There are
several that work well, but I am partial to "epitools".

```{r epitools}
# install.packages("epitools",repos="http://rweb.quant.ku.edu/cran/")
library("epitools")
```

The oddsratio function computes the odds ratio and its 95% confidence 
interval.

```{r oddsratio}
oddsratio(ti$Sex,ti$Survived)
```

Notice that this output is quite verbose. You can still choose
to print only the parts that you want, though.


```{r oodsratio-extract}
oddsratio(ti$Sex,ti$Survived)$measure
oddsratio(ti$Sex,ti$Survived)$measure[2,1]
```

Note that the odds of dying are 2 to 1 against for women and 5 to 1
in favor for men. This corresponds to an odds ratio of 1/10 (if you
put men in the denominator) or 10 (if you put women in the denominator).

The oddsratio function has a nice feature that allows you to reverse 
the order of the rows and columns, and thus control what goes in 
your denominator.

```{r oddsratio-rev}
oddsratio(ti$Sex,ti$Survived,rev="rows")
```

The relative risk and its associated confidence intervals are also
available in the epitools library, though it uses a different term
(risk ratio).

```{r riskratio}
riskratio(ti$Sex,ti$Survived)
```

This is actually the wrong risk ratio. The probability of dying
is 83% (about 5/6) among the men and 33% (exactly 1/3) among the
women. The ratio of these two probabilities is 2.5 (if you put
women in the denominator) or 0.4 (if you put men in the 
denominator). What epitools gives you by default is the relative
risk for the second column of your table. For ti$Survived, you
are computing the relative risk of living. You can fix this two
different ways.


```{r riskratio-died}
ti$died <- 1-ti$Survived
riskratio(ti$Sex,ti$died)
riskratio(ti$Sex,ti$Survived,rev="columns")
```

## On your own

Examine the relationship between passenger class and survival using
both odds ratios and relative risks. Try these functions both with
and without the rev="rows" argument.

## Left to do: analyze a second data set.

The Gardasil vaccine requires three shots in order to be effective. A study
conducted at Johns Hopkins looked at how often patients failed to get all
three shots. They wanted to see if insurance status, age, and other factors
could predict who was at greatest risk for failing to get all three shots.

The data set is available as an Excel spreadsheet at
--> http://www.amstat.org/publications/jse/v19n1/gardasil.xls

and a description of the file is available at
--> http://www.amstat.org/publications/jse/v19n1/gardasil.txt

Note to myself. I have not run through the analysis of this data set, yet,
but it should have many of the same features as the Titanic data set,
as almost all of the variables are categorical.

```{r read-gardasil}
fn <- "day2_gardasil.csv"
ga <- read.csv(fn)
```

## On your own

1. Create factors for AgeGroup, Race, Completed, Location.

2. Report which variables have missing data and how many of these values
are missing.

3. What proportion of patients completed all three shots?

4. Draw a bar chart showing the percentage of patients at
each of the four locations.

5. Use a crosstabulation to compare Age to AgeGroup, and
Location to LocationType. Are the recodings into AgeGroup
and LocationType done properly?

6. Create a new variable that combines the race categories
into white, and non-white. Calculate the proportion of white
patients at each of the four locations.

7. Does the likelihood of completing all four shots vary by AgeGroup,
Race, or Location? Calculate the appropriate percentages and 
relative risks.

8. Place all the key results into a Word document, add a bit of 
commentary, and turn it in.

## A third data set

If there is time, here is a third data set

diet <- read.table("http://lib.stat.cmu.edu/DASL/Datafiles/Fiber.html",
  skip=26,comment.char="<",header=TRUE)

## Save all my work

```{r save-image}
save.image("day2.RData")
```